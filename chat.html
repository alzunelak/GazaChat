<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bluetooth Chat</title>
<style>
body{margin:0;padding:0;font-family:Arial;background:#e5ddd5;}
.chat-header{background:#075E54;color:white;padding:10px 15px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;}
.chat-header img{width:40px;height:40px;border-radius:50%;margin-right:10px;}
.chat-messages{padding:10px;height:calc(100vh-180px);overflow-y:auto;display:flex;flex-direction:column;}
.chat-input{display:flex;padding:10px;background:#f0f0f0;position:sticky;bottom:0;}
.chat-input input{flex:1;padding:10px;border-radius:20px;border:1px solid #ccc;margin-right:5px;}
.chat-input button{padding:0 12px;border:none;background:#25D366;color:white;border-radius:50%;font-size:18px;cursor:pointer;margin-left:2px;}
.message{max-width:70%;padding:8px 12px;border-radius:18px;margin:5px 0;position:relative;word-wrap:break-word;}
.sent{background:#dcf8c6;align-self:flex-end;}
.received{background:white;align-self:flex-start;}
.timestamp{font-size:10px;color:#888;margin-top:2px;text-align:right;}
.attachment-menu{position:absolute;bottom:60px;left:10px;display:none;flex-direction:column;gap:10px;background:#fff;padding:10px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);}
.attachment-btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:#f0f0f0;}
.attachment-btn:hover{background:#e0e0e0;}
video, img{border-radius:8px;max-width:200px;margin-top:5px;}
</style>
</head>
<body>

<div class="chat-header">
  <div style="display:flex;align-items:center;">
    <img id="friendProfile" src="">
    <span id="friendName"></span>
  </div>
  <div>
    <button id="audioCallBtn">ğŸ¤</button>
    <button id="videoCallBtn">ğŸ“¹</button>
  </div>
</div>

<div class="chat-messages" id="chatMessages"></div>

<div class="chat-input">
  <button id="plusBtn">+</button>
  <input type="text" id="messageInput" placeholder="Type a message...">
  <button id="sendBtn">â¡</button>
</div>

<div id="attachmentMenu" class="attachment-menu">
  <button class="attachment-btn" id="sendFileBtn">ğŸ“„ File</button>
  <button class="attachment-btn" id="takePhotoBtn">ğŸ“¸ Take Photo</button>
  <button class="attachment-btn" id="choosePhotoBtn">ğŸ–¼ï¸ Gallery</button>
  <button class="attachment-btn" id="sendLocationBtn">ğŸ“ Location</button>
</div>

<video id="localVideo" autoplay muted style="display:none;position:fixed;bottom:80px;right:10px;width:150px;height:150px;"></video>
<video id="remoteVideo" autoplay style="display:none;position:fixed;bottom:80px;right:170px;width:150px;height:150px;"></video>

<script>
// --- Setup ---
const params = new URLSearchParams(window.location.search);
const friend = params.get('friend');
const profile = params.get('profile');
document.getElementById('friendName').innerText = friend;
document.getElementById('friendProfile').src = profile;

let blockedUsers = JSON.parse(localStorage.getItem('blockedUsers')||'[]');
if(blockedUsers.includes(friend)){
  alert(`${friend} is blocked!`);
  window.location.href=`blockuser.html?friend=${friend}`;
}

// Bluetooth variables
let bluetoothDevice, btServer, btService, btCharacteristic;
async function connectBluetooth(){
  try {
    bluetoothDevice = await navigator.bluetooth.requestDevice({acceptAllDevices:true, optionalServices:['0000ffe0-0000-1000-8000-00805f9b34fb']});
    btServer = await bluetoothDevice.gatt.connect();
    btService = await btServer.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
    btCharacteristic = await btService.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
    await btCharacteristic.startNotifications();
    btCharacteristic.addEventListener('characteristicvaluechanged', e=>{
      const data = new TextDecoder().decode(e.target.value);
      const msgObj = JSON.parse(data);
      const messages = getChat(); messages.push({...msgObj,sender:'friend'}); saveChat(messages); loadChat();
    });
  } catch(e){ console.log(e); alert('Bluetooth failed'); }
}

// Chat storage
const messagesDiv = document.getElementById('chatMessages');
const input = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const plusBtn = document.getElementById('plusBtn');
const attachmentMenu = document.getElementById('attachmentMenu');

function getChat(){ return JSON.parse(localStorage.getItem(`chat_${friend}`)||'[]'); }
function saveChat(messages){ localStorage.setItem(`chat_${friend}`, JSON.stringify(messages)); }

function formatTime(){ const d=new Date(); return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; }

function loadChat(){
  messagesDiv.innerHTML='';
  const messages=getChat();
  messages.forEach(msg=>{
    const div=document.createElement('div');
    div.classList.add('message', msg.sender==='me'?'sent':'received');
    if(msg.type==='text') div.innerText=msg.data;
    if(msg.type==='image'){ const img=document.createElement('img'); img.src=msg.data; div.appendChild(img); }
    if(msg.type==='file'){ const a=document.createElement('a'); a.href=msg.data; a.download=msg.name; a.innerText='ğŸ“„ '+msg.name; div.appendChild(a); }
    if(msg.type==='video'){ const v=document.createElement('video'); v.src=msg.data; v.controls=true; div.appendChild(v); }
    if(msg.type==='location'){ const a=document.createElement('a'); a.href=`https://www.google.com/maps?q=${msg.data.lat},${msg.data.lng}`; a.target='_blank'; a.innerText='ğŸ“ Shared Location'; div.appendChild(a); }
    const ts=document.createElement('div'); ts.className='timestamp'; ts.innerText=msg.time||formatTime();
    div.appendChild(ts);
    messagesDiv.appendChild(div);
  });
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

// Send message
async function sendBluetoothMessage(msgObj){
  const enc = new TextEncoder();
  if(btCharacteristic){
    await btCharacteristic.writeValue(enc.encode(JSON.stringify(msgObj)));
  }
}

sendBtn.addEventListener('click',async ()=>{
  if(blockedUsers.includes(friend)){ alert('Cannot send to blocked user'); return; }
  const text=input.value.trim(); if(!text) return;
  const msgObj={type:'text',data:text,sender:'me',time:formatTime()};
  const messages=getChat(); messages.push(msgObj); saveChat(messages); input.value=''; loadChat();
  await sendBluetoothMessage(msgObj);
});

// --- Attachment Menu ---
plusBtn.addEventListener('click', ()=>attachmentMenu.style.display = attachmentMenu.style.display==='flex'?'none':'flex');

function sendFile(callback){
  const fileInput=document.createElement('input');
  fileInput.type='file';
  fileInput.onchange=e=>{
    const file=e.target.files[0];
    const reader=new FileReader();
    reader.onload=async ()=>{
      callback(file.name,reader.result);
      attachmentMenu.style.display='none';
    };
    reader.readAsDataURL(file);
  };
  fileInput.click();
}

document.getElementById('sendFileBtn').addEventListener('click',()=>sendFile(async (name,data)=>{
  const msgObj={type:'file',data,name,sender:'me',time:formatTime()};
  const messages=getChat(); messages.push(msgObj); saveChat(messages); loadChat();
  await sendBluetoothMessage(msgObj);
}));

document.getElementById('takePhotoBtn').addEventListener('click',()=>sendFile(async (name,data)=>{
  const msgObj={type:'image',data,sender:'me',time:formatTime()};
  const messages=getChat(); messages.push(msgObj); saveChat(messages); loadChat();
  await sendBluetoothMessage(msgObj);
}));

document.getElementById('choosePhotoBtn').addEventListener('click',()=>sendFile(async (name,data)=>{
  const msgObj={type:'image',data,sender:'me',time:formatTime()};
  const messages=getChat(); messages.push(msgObj); saveChat(messages); loadChat();
  await sendBluetoothMessage(msgObj);
}));

document.getElementById('sendLocationBtn').addEventListener('click',()=>{ 
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos=>{
      const {latitude,longitude}=pos.coords;
      const msgObj={type:'location',data:{lat:latitude,lng:longitude},sender:'me',time:formatTime()};
      const messages=getChat(); messages.push(msgObj); saveChat(messages); loadChat();
      await sendBluetoothMessage(msgObj);
      attachmentMenu.style.display='none';
    });
  } else alert("Geolocation not supported");
});

// --- Audio/Video Call ---
let localStream, remoteVideoEl=document.getElementById('remoteVideo'), localVideoEl=document.getElementById('localVideo');
async function startCall(isVideo){
  localStream = await navigator.mediaDevices.getUserMedia({audio:true,video:isVideo});
  localVideoEl.srcObject = localStream; localVideoEl.style.display='block';
  // Note: full streaming over Bluetooth may need custom chunking and decoding
  alert('Audio/Video call started (demo, low-res over Bluetooth)');
}

document.getElementById('audioCallBtn').onclick=()=>startCall(false);
document.getElementById('videoCallBtn').onclick=()=>startCall(true);

// --- Initialize ---
loadChat();
connectBluetooth();
</script>

</body>
</html>
